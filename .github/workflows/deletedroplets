name: Delete Droplets

on:
  workflow_run:
    workflows: [Debugging Workflow]
    types:
      - completed
  workflow_call:
    inputs:
      run_id:
        required: true
        type: number
      tag:
        required: true
        type: string
      success:
        required: true
        type: boolean
      server:
        required: true
        type: string
      pr:
        required: true
        type: string
      
jobs:
  on-success:
    runs-on: ubuntu-latest
    if: ${{ inputs.success == 'true' }}
    steps:
      - name: get logs
        uses: dawidd6/action-download-artifact@v2
        with:
          run_id: ${{ inputs.run.id}}
          if_no_artifact_found: warn
      - name: discord success message
        uses: appleboy/discord-action@master
        with:
          webhook_id: ${{ secrets.DISCORD_WEBHOOK_ID }}
          webhook_token: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
          color: "#42f545"
          username: "GitHub Bot"
          message: " ${{ inputs.tag }}:PR ${{ inputs.pr }} was successful: droplets from this workflow (tag ${{ inputs.tag }}) will be deleted in 15 min"
          file: ./results/results.log
      - name: delete droplets
        if: success() || failure()
        run: |
          sleep 15m
          curl -X DELETE \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DIGITALOCEAN_TOKEN" \
            "https://api.digitalocean.com/v2/droplets?tag_name=${{ inputs.tag }}"
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
      - name: mark server as available
        uses: appleboy/ssh-action@master
        with:
          host: server.${{ inputs.server }}.clustercat.com
          username: root
          key: ${{ secrets.TESTING_SSH_KEY }}
          script: |
            rm /tmp/branchtest

  on-failure:
    runs-on: ubuntu-latest
    if: ${{ inputs.success == 'false' }}
    steps:
      - name: get logs
        uses: dawidd6/action-download-artifact@v2
        with:
          run_id: ${{ inputs.run.id}}
          if_no_artifact_found: warn
      - name: discord success message
        uses: appleboy/discord-action@master
        with:
          webhook_id: ${{ secrets.DISCORD_WEBHOOK_ID }}
          webhook_token: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
          color: "#42f545"
          username: "GitHub Bot"
          message: " ${{ inputs.tag }}:PR ${{ inputs.pr }} failed: droplets from this workflow (tag ${{ inputs.tag }}) will be deleted in 1 hour"
          file: ./results/results.log
      - name: delete droplets
        if: success() || failure()
        run: |
          sleep 1h
          curl -X DELETE \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DIGITALOCEAN_TOKEN" \
            "https://api.digitalocean.com/v2/droplets?tag_name=${{ inputs.tag }}"
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
      - name: mark server as available
        uses: appleboy/ssh-action@master
        with:
          host: server.${{ inputs.server }}.clustercat.com
          username: root
          key: ${{ secrets.TESTING_SSH_KEY }}
          script: |
            rm /tmp/branchtest
